import{J as e}from"./justvalidation.js";const t=document.getElementById("recordButton"),n=document.getElementById("searchInput"),o=n.closest("form"),a=document.getElementById("searchButton"),i=document.getElementById("searchInputError"),s=document.getElementById("voiceSearchError");let r,c=!1;const d=window.AudioContext||window.webkitAudioContext,l=window.AudioWorkletNode;let u,m,p,f,g=[];let h,w=[];function y(e,t=.07){if(!m)return;m&&(w.forEach((e=>{e.stop(),e.disconnect()})),w=[]);const n=m.currentTime;e.forEach(((e,o)=>{const a=m.createOscillator(),i=m.createGain();a.frequency.setValueAtTime(e,n+o*t),a.type="sine",a.connect(i),i.connect(m.destination),i.gain.setValueAtTime(0,n+o*t),i.gain.linearRampToValueAtTime(1,n+o*t+.01),i.gain.linearRampToValueAtTime(0,n+o*t+t),a.start(n+o*t),a.stop(n+o*t+t),w.push(a)}))}function v(e){c=e,e?(t.classList.add("recording"),t.ariaPressed=!0):(t.classList.remove("recording"),t.ariaPressed=!1),t.focus()}function b(e,t,n){for(let o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}function x(){const e=g.reduce(((e,t)=>e+t.length),0),t=new Float32Array(e);let n=0;for(const i of g)t.set(i,n),n+=i.length;const o=function(e,t,n){const o=n/t,a=Math.round(e.length*o),i=new Float32Array(a);for(let s=0;s<a;s++){const t=s/o,n=Math.floor(t),a=Math.ceil(t),r=t-n;let c;if(a===n)c=e[n];else{const t=e[n];c=t+(e[a]-t)*r}i[s]=c}return i}(t,u.sampleRate,16e3),a=function(e,t,n){const o=2*t,a=new ArrayBuffer(44+2*e.length),i=new DataView(a);b(i,0,"RIFF"),i.setUint32(4,36+2*e.length,!0),b(i,8,"WAVE"),b(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,t,!0),i.setUint32(24,n,!0),i.setUint32(28,n*o,!0),i.setUint16(32,o,!0),i.setUint16(34,16,!0),b(i,36,"data"),i.setUint32(40,2*e.length,!0);let s=44;for(let r=0;r<e.length;r++,s+=2){const t=Math.max(-1,Math.min(1,e[r])),n=t<0?32768*t:32767*t;i.setInt16(s,n,!0)}return i.buffer}(o,1,16e3);return a}function L(e){if(e){const e=encodeURIComponent("\n        <svg width='60' height='20' viewBox='0 0 60 20' xmlns='http://www.w3.org/2000/svg'>\n            <circle cx='10' cy='10' r='5' fill='black'>\n                <animate attributeName='opacity' values='0;1;0' dur='1s' repeatCount='indefinite' begin='0s'/>\n            </circle>\n            <circle cx='30' cy='10' r='5' fill='black'>\n                <animate attributeName='opacity' values='0;1;0' dur='1s' repeatCount='indefinite' begin='0.3s'/>\n            </circle>\n            <circle cx='50' cy='10' r='5' fill='black'>\n                <animate attributeName='opacity' values='0;1;0' dur='1s' repeatCount='indefinite' begin='0.6s'/>\n            </circle>\n        </svg>");n.style.backgroundImage=`url("data:image/svg+xml;utf8,${e}")`,n.style.backgroundRepeat="no-repeat",n.style.backgroundPosition="right 10px center",t.setAttribute("disabled","true"),r.innerText="جار المعالجة...",n.placeholder=""}else n.style.backgroundImage="",t.removeAttribute("disabled"),r.innerText="",n.placeholder="البحث برقم الحملة أو اسم الحملة"}function A(){g=[],u=null,p=null,clearTimeout(f),v(!1)}function C(e){e?(s.textContent=e,s.classList.remove("d-none"),y([293.66,293.66,293.66],.1)):(s.classList.add("d-none"),s.textContent="")}async function E(){C();try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});u=new AudioContext;const o=u.createMediaStreamSource(e);await u.audioWorklet.addModule(new URL(""+new URL("../processor.js",import.meta.url).href,import.meta.url));const s=new AudioWorkletNode(u,"custom-processor");s.port.onmessage=e=>{g.push(new Float32Array(e.data))},o.connect(s),s.connect(u.destination),p=new MediaRecorder(e),p.addEventListener("stop",(async()=>{e.getTracks().forEach((e=>e.stop())),y([587.33,440,293.66]);!function(e){L(!0);const t=new FormData,o=new Blob([e],{type:"audio/wav"});t.append("file",o,"recording.wav"),fetch("/api/speechToText",{method:"POST",headers:{accept:"application/json"},body:t}).then((e=>e.json())).then((e=>{L(!1),e.isSuccess?(n.value=e.description,a.click()):(i.textContent="",C("الخدمة غير متاحة حاليًّا، يرجى المحاولة لاحقًا."),L(!1))})).catch((e=>{i.textContent="",C("الخدمة غير متاحة حاليًّا، يرجى المحاولة لاحقًا."),L(!1)}))}(x()),s.port.postMessage("stop"),u.close(),A()})),y([293.66,440,587.33]),r.innerText="تحدث الآن",p.start(),t.classList.add("recording"),t.focus(),t.classList.remove("fa-microphone","text-primary"),t.classList.add("fa-stop","text-white","bg-primary"),v(!0),f=setTimeout((()=>{k()}),6e3)}catch(e){t.classList.remove("recording"),C("تعذر بدء التسجيل. يرجى التأكد من منح الوصول إلى المايكروفون وإعادة المحاولة."),A()}}function k(){p?(t.classList.add("fa-microphone","text-primary"),t.classList.remove("fa-stop","text-white","bg-primary"),t.classList.remove("recording"),p.stop()):A()}function T(){const e=function(e){const t=window.location.search;return new URLSearchParams(t).get(e)}(n.name);e&&(n.value=decodeURIComponent(e)),(d&&l?(t.classList.remove("d-none"),t.disabled=!1,1):(t.classList.add("d-none"),t.disabled=!0,0))?t.addEventListener("click",(e=>{m||(m=new AudioContext),c?k():E(),e.preventDefault()})):t.classList.add("d-none"),n.addEventListener("keyPress",(e=>{"Enter"===e.key&&a.click()}))}document.addEventListener("DOMContentLoaded",(()=>{r=document.getElementById("srNotificationArea"),T(),h=new e(o,{validateBeforeSubmitting:!0}),h.addField(n,[{rule:"required",errorMessage:"الحقل مطلوب"},{rule:"customRegexp",value:/^(CW)-\d{6,30}$|^[ا-يأؤءإآلالإ]+[ا-يأءئؤلإآلإلاىًٌٍَُِّْ\s]*$/,errorMessage:"مدخلات البحث غير صحيحة"}],{errorsContainer:i}).onSuccess((e=>{a.disabled=!0,o.submit()})).onFail((e=>{a.disabled=!1,y([293.66,293.66,293.66],.1)}))})),document.addEventListener("input",(()=>{s.textContent=""}));
//# sourceMappingURL=searchSoutechScript.js.map
